gobierno_ara_19 <- sub_set %>%
filter(set_id=="aragon") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_bal_19 <- sub_set %>%
filter(set_id=="baleares") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_ext_19 <- sub_set %>%
filter(set_id=="extremadura") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_cva_19 <- sub_set %>%
filter(set_id=="cvalenciana") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_mad_19 <- sub_set %>%
filter(set_id=="madrid") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_val_19 <- sub_set %>%
filter(set_id=="valencia") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_esp_19 <- sub_set %>%
filter(set_id=="espana") %>%
mutate_at(vars(3:8), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
#/ barcelona
bar_set <-  predi28A26M %>%
filter(set_id=="barcelona") %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
select(datetime, set_id, coalition_left= contract1, coalition_trans= contract2, coalition_indy= contract3,
singlecolor_left= contract4, singlecolor_trans= contract5, singlecolor_indy= contract6) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
rowwise() %>%
mutate(sum = 100- sum(coalition_left, coalition_trans, coalition_indy, singlecolor_trans, singlecolor_indy, singlecolor_left))
bar_gather <-bar_set %>%
ungroup(datetime) %>%
select(set_id, datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición mixto*`="coalition_trans", `Gobierno de coalición de soberanistas`="coalition_indy", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor mixto*`="singlecolor_trans", `Gobierno monocolor de soberanistas`="singlecolor_indy", `Repetición electoral`="sum") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición electoral`)) %>%
mutate(coloract = ifelse(str_detect(type, "Gobierno de coalición de izquierdas"), "#9A0000",
ifelse(str_detect(type,  "Gobierno de coalición mixto*"), "#bf5f82",
ifelse(str_detect(type,  "Gobierno de coalición de soberanistas"), "#c79a00",
ifelse(str_detect(type,  "Gobierno monocolor de izquierdas"), "#FF3827",
ifelse(str_detect(type,  "Gobierno monocolor mixto*"), "#f48fb1",
ifelse(str_detect(type,  "Gobierno monocolor de soberanistas"), "#ffca28",
ifelse(str_detect(type,  "Repetición electoral"), "#babdbe",
"other"))))))))
gobierno_bar_19 <- bar_set %>%
mutate_at(vars(3:8), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
##general elections
#####VOTO
intrapolation_reduce <- intrapolation_inner %>%
filter(probability=="50") %>%
select(-probability) %>%
ungroup() %>%
add_row(datetime= "2019-04-19",
up= 14.29,
vox= 12.83,
cs= 16.04,
pp= 21.13,
psoe= 29.59) %>%
mutate_at(vars(2:6), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
intrapolation_little <- intrapolation_inner %>%
ungroup(datetime) %>%
filter(probability=="50") %>%
ungroup() %>%
add_row(datetime= "2019-04-19",
up= 14.29,
vox= 12.83,
cs= 16.04,
pp= 21.13,
psoe= 29.59) %>%
mutate_at(vars(3:7), ~(.*96)/100) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2) %>%
select(datetime2, `Unidas Podemos`= "up", VOX="vox", Ciudadanos="cs", PP="pp", PSOE="psoe") %>%
gather("party", "vote", c(`Unidas Podemos`:'PSOE')) %>%
group_by(party) %>%
mutate(diff = vote - lag(vote, default = first(vote))) %>%
filter(datetime2 == max(datetime2)) %>%
mutate_if(is.numeric, round, 2) %>%
select(party, vote, diff) %>%
arrange(desc(vote))
intrapolation_gather <- intrapolation_reduce %>%
select(datetime, UP= "up", VOX="vox", Cs="cs", PP="pp", PSOE="psoe") %>%
gather("party", "vote", c('UP':'PSOE'))
first_mad_set <-  predi28A26M %>%
filter(set_id== "madrid_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Ciudadanos=contract3, `Más Madrid`=contract4, Other) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_cma_set <-  predi28A26M %>%
filter(set_id== "cmadrid_a") %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Ciudadanos=contract3, `Más Madrid`=contract4, Other=contract5)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_val_set <-  predi28A26M %>%
filter(set_id== "valencia_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Compromís=contract3, `Ciutadans`=contract4, Other)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_bar_set <-  predi28A26M %>%
filter(set_id== "barcelona_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, ERC=contract1, BComú=contract2, PSC=contract3, Valls=contract4, Other)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_set <- first_mad_set %>%
bind_rows(first_cma_set, first_val_set, first_bar_set) %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime, set_id) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
select(datetime, datetime2, everything())
#######ejemplo
`Contratos de voto al PP` <- c("Contrato A", "Contrato B", "Contrato C", "Contrato D", "Contrato E")
`Margen de estimación de voto al PP` <- c("17% votos o menos", "17%-19'99% votos", "20%-22'99% votos", "23%-25'99% votos", "26% votos o más")
`Probabilidad de cada contrato (ejemplo)` <- c("10%", "20%", "40%", "20%", "10%")
Ejemplo <- as.data.frame(cbind(`Contratos de voto al PP`, `Margen de estimación de voto al PP`, `Probabilidad de cada contrato (ejemplo)`))
`Estimación de voto al PP` <- c("100% de votos", "> 26% de votos", "> 23% de votos", "21% de votos", "> 20% de votos", "> 17% de votos", "> 0% de votos")
`Probabilidad acumulada` <- c("0%", "10%", "30%", "50%", "70%", "90%", "100%")
`Agregación` <- c("Ninguno",
"Contrato E",
"Contrato D + Contrato E",
"Resultado de la interpolación",
"Contrato C + Contrato D + Contrato E",
"Contrato B + Contrato C +  Contrato D + Contrato E",
"Contrato A + Contrato B + Contrato C + Contrato D + Contrato E")
predi28a <- read.csv("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/26M/code/pricehistory-2019.05.19-16.00.csv")
predi28a <- predi28a %>%
separate(prices, c('contract1', 'contract2', 'contract3', 'contract4', 'contract5', 'contract6', 'contract7'), sep = ',') %>%
separate(time, c('weekday', 'monthday', 'yeartime'), sep= ',') %>%
mutate(datetime= mdy_hm(paste(monthday, yeartime, sep = ' '))) %>%
mutate_at(vars(contract1:contract7), funs(str_sub(., 20))) %>%
#remove the IDs from each contract
mutate_at(vars(contract1:contract7), funs(as.numeric)) %>%
mutate(market_id = ifelse(str_detect(market_id, "zSk5eS8p6PGZZ2MMa"), "28a_26", "other")) %>%
#change name of the market
mutate(set_id = ifelse(str_detect(set_id,  "KGezYwmZ2XKQ8JE8s"), "up_set",
#change the names of contractsets
ifelse(str_detect(set_id,  "jQuqN3mMzzA64p7ee"), "vox_set",
ifelse(str_detect(set_id, "c3np3bcBR8vHTK2cu"), "cs_set",
ifelse(str_detect(set_id, "P3g8GuWFdrgshsRzb"), "pp_set",
ifelse(str_detect(set_id, "bgwmJDWfJvoCv6ThE"), "psoe_set",
ifelse(str_detect(set_id, "wD6TZthrHCvBsA724"),
"generales_set", "other"))))))) %>%
filter(market_id== "28a_26" & set_id!= "other") %>%
#select only 28a_26m market > only 28A contractsets
select(datetime, set_id, c(contract1:contract7))
#######
generales_set <-  predi28A26M %>%
filter(set_id== "generales_set") %>%
select(datetime, coalition_left= contract1, coalition_center= contract2, coalition_right= contract3,
singlecolor_left= contract4, singlecolor_center= contract5, singlecolor_right= contract6, rep_elections= contract7)
generales_reduce <- generales_set %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
mutate_all(list(mean=mean)) %>%
select(-c(2:8)) %>%
distinct() %>%
select(coalition_left= coalition_left_mean,
coalition_center=coalition_center_mean,
coalition_right=coalition_right_mean,
singlecolor_left=singlecolor_left_mean,
singlecolor_center=singlecolor_center_mean,
singlecolor_right=singlecolor_right_mean,
repetition_elections=rep_elections_mean) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
filter(datetime<"2019-05-05")
generales_little <- generales_reduce %>%
ungroup(datetime) %>%
select(datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición de centro`="coalition_center", `Gobierno de coalición de derechas`="coalition_right", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor de centro`="singlecolor_center", `Gobierno monocolor de derechas`="singlecolor_right", `Repetición de elecciones`="repetition_elections") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición de elecciones`)) %>%
mutate(diff =  prob - lag(prob, default = first(prob))) %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(type, prob, diff) %>%
arrange(desc(prob))
generales_gather <- generales_reduce %>% select(datetime, `Coalición de izquierda`= "coalition_left", `Coalición de centro`="coalition_center", `Coalición de derecha`="coalition_right", `Monocolor de izquierda`="singlecolor_left", `Monocolor de centro`="singlecolor_center", `Monocolor de derecha`="singlecolor_right", `Repetición electoral`="repetition_elections") %>%
gather("type", "prob", c(`Coalición de izquierda`:`Repetición electoral`))
index <- sub_gather %>%
bind_rows(bar_gather) %>%
spread(set_id, prob) %>%
select(datetime, type, coloract, España= "espana", `C. Valenciana`= "cvalenciana", `C. Madrid`="cmadrid", Madrid="madrid", Barcelona="barcelona", Valencia="valencia")
index_graph <- index %>%
gather("set_id", "prob", c(España:Valencia)) %>%
group_by(set_id, type) %>%
drop_na() %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(coloract, datetime, set_id, type, prob)
index <- sub_gather %>%
bind_rows(bar_gather) %>%
spread(set_id, prob) %>%
select(datetime, type, coloract, España= "espana", `C. Valenciana`= "cvalenciana", `C. Madrid`="cmadrid", Madrid="madrid", Barcelona="barcelona", Valencia="valencia")
View(sub_gather)
Sys.setlocale("LC_MESSAGES", 'en_GB.UTF-8')
Sys.setenv(LANG = "en_US.UTF-8")
predi28A26M <- read.csv("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/26M/code/pricehistory-2019.05.19-16.20.csv")
load("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/28A y 26M/intrapolation_all.RData")
load("/Users/ortega/Alberto/Alberto López Ortega/Side projects/S1 - Predi w Strijbis/Prediction markets/28A y 26M/intrapolation_inner.RData")
predi28A26M <- predi28A26M %>%
separate(prices, c('contract1', 'contract2', 'contract3', 'contract4', 'contract5', 'contract6', 'contract7'), sep = ',') %>%
separate(time, c('weekday', 'monthday', 'yeartime'), sep= ',') %>%
mutate(datetime= mdy_hm(paste(monthday, yeartime, sep = ' '))) %>%
mutate_at(vars(contract1:contract7), funs(str_sub(., 20))) %>%
#remove the IDs from each contract
mutate_at(vars(contract1:contract7), funs(as.numeric)) %>%
mutate(market_id = ifelse(str_detect(X...market_id, "zSk5eS8p6PGZZ2MMa"), "28a_26", "other")) %>%
#change name of the market
mutate(set_id = ifelse(str_detect(set_id,  "C527E27e4v3oih4Yw"), "comision",
ifelse(str_detect(set_id,  "jGWXeuYvj92bQ78ev"), "cmadrid",
ifelse(str_detect(set_id, "aBNaTgnSxQEaXwAeC"), "aragon",
ifelse(str_detect(set_id, "ryirGudjDyK3FnBGT"), "extremadura",
ifelse(str_detect(set_id, "8YcCXd28NdTyupxoH"), "baleares",
ifelse(str_detect(set_id, "mhSCHid5juQJQfAzZ"), "madrid",
ifelse(str_detect(set_id, "WfRT5gpCkj6ncKjnF"), "barcelona",
ifelse(str_detect(set_id, "5LR8WtEjLEcnqqPY5"), "cvalenciana",
ifelse(str_detect(set_id, "8MHt5GHbaGeHq3dwS"), "cmadrid_a",
ifelse(str_detect(set_id, "giXvSY9EdDcsYCgPF"), "madrid_a",
ifelse(str_detect(set_id, "LB7ab8sQ4p4uQQgWJ"), "valencia_a",
ifelse(str_detect(set_id, "q5N6ykCAwDQkb6qHv"), "barcelona_a",
ifelse(str_detect(set_id, "wD6TZthrHCvBsA724"), "espana",
ifelse(str_detect(set_id, "NSCcQ9qaKYTZtiniC"), "valencia", "other"))))))))))))))) %>%
filter(market_id== "28a_26" & set_id!= "other") %>%
#select only 28a_26m market > only 28A contractsets
select(datetime, set_id, c(contract1:contract7))
###Commission
comision_set <-  predi28A26M %>%
filter(set_id== "comision") %>%
select(datetime, `Manfred Weber (EPP)`= contract1, `Frans Timmermans (PES)`= contract2, `Jan Zahradil (ECR)`= contract3, `Viola Tomic (GUE)`= contract4, `Guy Verhofstadt (ALDE)`= contract5, `Otro/a`= contract6)
comision_gather  <- comision_set %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
mutate_all(list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
gather("type", "prob", c(`Manfred Weber (EPP)`:`Otro/a`))
gobierno_eu_19 <- comision_set %>%
mutate_at(vars(2:7), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
######26M Regional and local ---- but Barcelona
sub_set <-  predi28A26M %>%
filter(set_id!= "comision" & set_id!="barcelona" & set_id!= "cmadrid_a" & set_id!="madrid_a" & set_id!= "barcelona_a" & set_id!="valencia_a") %>%
select(datetime, set_id, coalition_left= contract1, coalition_center= contract2, coalition_right= contract3,
singlecolor_left= contract4, singlecolor_center= contract5, singlecolor_right= contract6) %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime, set_id) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
rowwise() %>%
mutate(sum = 100- sum(coalition_left, coalition_center, coalition_right, singlecolor_center, singlecolor_right, singlecolor_left))
sub_gather <- sub_set %>%
ungroup(datetime) %>%
select(set_id, datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición de centro`="coalition_center", `Gobierno de coalición de derechas`="coalition_right", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor de centro`="singlecolor_center", `Gobierno monocolor de derechas`="singlecolor_right", `Repetición electoral`="sum") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición electoral`)) %>%
mutate(coloract = ifelse(str_detect(type, "Gobierno de coalición de izquierdas"), "#9A0000",
ifelse(str_detect(type,  "Gobierno de coalición de centro"), "#C57420",
ifelse(str_detect(type,  "Gobierno de coalición de derechas"), "#0000BA",
ifelse(str_detect(type,  "Gobierno monocolor de izquierdas"), "#FF3827",
ifelse(str_detect(type,  "Gobierno monocolor de centro"), "#FF9300",
ifelse(str_detect(type,  "Gobierno monocolor de derechas"), "#04AAFF",
ifelse(str_detect(type,  "Repetición electoral"), "#babdbe",
"other"))))))))
sub_little <- sub_gather %>%
group_by(set_id, type) %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(coloract, datetime, set_id, type, prob) %>%
arrange(desc(prob))
##autonomicas
gobierno_cma_19 <- sub_set %>%
filter(set_id=="cmadrid") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_ara_19 <- sub_set %>%
filter(set_id=="aragon") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_bal_19 <- sub_set %>%
filter(set_id=="baleares") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_ext_19 <- sub_set %>%
filter(set_id=="extremadura") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_cva_19 <- sub_set %>%
filter(set_id=="cvalenciana") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
#locales
gobierno_mad_19 <- sub_set %>%
filter(set_id=="madrid") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
gobierno_val_19 <- sub_set %>%
filter(set_id=="valencia") %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
#espana
gobierno_esp_19 <- sub_set %>%
filter(set_id=="espana") %>%
mutate_at(vars(3:8), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
#/ barcelona
bar_set <-  predi28A26M %>%
filter(set_id=="barcelona") %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
select(datetime, set_id, coalition_left= contract1, coalition_trans= contract2, coalition_indy= contract3,
singlecolor_left= contract4, singlecolor_trans= contract5, singlecolor_indy= contract6) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
rowwise() %>%
mutate(sum = 100- sum(coalition_left, coalition_trans, coalition_indy, singlecolor_trans, singlecolor_indy, singlecolor_left))
bar_gather <-bar_set %>%
ungroup(datetime) %>%
select(set_id, datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición mixto*`="coalition_trans", `Gobierno de coalición de soberanistas`="coalition_indy", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor mixto*`="singlecolor_trans", `Gobierno monocolor de soberanistas`="singlecolor_indy", `Repetición electoral`="sum") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición electoral`)) %>%
mutate(coloract = ifelse(str_detect(type, "Gobierno de coalición de izquierdas"), "#9A0000",
ifelse(str_detect(type,  "Gobierno de coalición mixto*"), "#bf5f82",
ifelse(str_detect(type,  "Gobierno de coalición de soberanistas"), "#c79a00",
ifelse(str_detect(type,  "Gobierno monocolor de izquierdas"), "#FF3827",
ifelse(str_detect(type,  "Gobierno monocolor mixto*"), "#f48fb1",
ifelse(str_detect(type,  "Gobierno monocolor de soberanistas"), "#ffca28",
ifelse(str_detect(type,  "Repetición electoral"), "#babdbe",
"other"))))))))
gobierno_bar_19 <- bar_set %>%
mutate_at(vars(3:8), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
##general elections
#####VOTO
intrapolation_reduce <- intrapolation_inner %>%
filter(probability=="50") %>%
select(-probability) %>%
ungroup() %>%
add_row(datetime= "2019-04-19",
up= 14.29,
vox= 12.83,
cs= 16.04,
pp= 21.13,
psoe= 29.59) %>%
mutate_at(vars(2:6), ~(.*96)/100) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
intrapolation_little <- intrapolation_inner %>%
ungroup(datetime) %>%
filter(probability=="50") %>%
ungroup() %>%
add_row(datetime= "2019-04-19",
up= 14.29,
vox= 12.83,
cs= 16.04,
pp= 21.13,
psoe= 29.59) %>%
mutate_at(vars(3:7), ~(.*96)/100) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2) %>%
select(datetime2, `Unidas Podemos`= "up", VOX="vox", Ciudadanos="cs", PP="pp", PSOE="psoe") %>%
gather("party", "vote", c(`Unidas Podemos`:'PSOE')) %>%
group_by(party) %>%
mutate(diff = vote - lag(vote, default = first(vote))) %>%
filter(datetime2 == max(datetime2)) %>%
mutate_if(is.numeric, round, 2) %>%
select(party, vote, diff) %>%
arrange(desc(vote))
intrapolation_gather <- intrapolation_reduce %>%
select(datetime, UP= "up", VOX="vox", Cs="cs", PP="pp", PSOE="psoe") %>%
gather("party", "vote", c('UP':'PSOE'))
#######First party thingy
first_mad_set <-  predi28A26M %>%
filter(set_id== "madrid_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Ciudadanos=contract3, `Más Madrid`=contract4, Other) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_cma_set <-  predi28A26M %>%
filter(set_id== "cmadrid_a") %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Ciudadanos=contract3, `Más Madrid`=contract4, Other=contract5)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_val_set <-  predi28A26M %>%
filter(set_id== "valencia_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, PSOE=contract1, PP=contract2, Compromís=contract3, `Ciutadans`=contract4, Other)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_bar_set <-  predi28A26M %>%
filter(set_id== "barcelona_a") %>%
rowwise() %>%
mutate("Other"= sum(contract5, contract6)) %>%
select(datetime, set_id, ERC=contract1, BComú=contract2, PSC=contract3, Valls=contract4, Other)%>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
arrange(datetime2)
first_set <- first_mad_set %>%
bind_rows(first_cma_set, first_val_set, first_bar_set) %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime, set_id) %>%
mutate_if(is.numeric,list(mean)) %>%
distinct()  %>%
mutate_if(is.numeric, round, 2) %>%
select(datetime, datetime2, everything())
#######ejemplo
`Contratos de voto al PP` <- c("Contrato A", "Contrato B", "Contrato C", "Contrato D", "Contrato E")
`Margen de estimación de voto al PP` <- c("17% votos o menos", "17%-19'99% votos", "20%-22'99% votos", "23%-25'99% votos", "26% votos o más")
`Probabilidad de cada contrato (ejemplo)` <- c("10%", "20%", "40%", "20%", "10%")
Ejemplo <- as.data.frame(cbind(`Contratos de voto al PP`, `Margen de estimación de voto al PP`, `Probabilidad de cada contrato (ejemplo)`))
`Estimación de voto al PP` <- c("100% de votos", "> 26% de votos", "> 23% de votos", "21% de votos", "> 20% de votos", "> 17% de votos", "> 0% de votos")
`Probabilidad acumulada` <- c("0%", "10%", "30%", "50%", "70%", "90%", "100%")
`Agregación` <- c("Ninguno",
"Contrato E",
"Contrato D + Contrato E",
"Resultado de la interpolación",
"Contrato C + Contrato D + Contrato E",
"Contrato B + Contrato C +  Contrato D + Contrato E",
"Contrato A + Contrato B + Contrato C + Contrato D + Contrato E")
Ejemplo_2 <- as.data.frame(cbind(`Estimación de voto al PP`, `Probabilidad acumulada`, `Agregación`))
x <- c(100, 26, 23, NA, 20, 17, 0)
y <- c(0, 10, 30, 50, 70, 90, 100)
Ejemplo_3 <- as.data.frame(cbind(x, y))
Ejemplo_3$vote_ = coalesce(as.numeric(x), na.approx(x, y))
#######
generales_set <-  predi28A26M %>%
filter(set_id== "generales_set") %>%
select(datetime, coalition_left= contract1, coalition_center= contract2, coalition_right= contract3,
singlecolor_left= contract4, singlecolor_center= contract5, singlecolor_right= contract6, rep_elections= contract7)
generales_reduce <- generales_set %>%
mutate(datetime = round_date(datetime, unit="24 hours")) %>%
group_by(datetime) %>%
mutate_all(list(mean=mean)) %>%
select(-c(2:8)) %>%
distinct() %>%
select(coalition_left= coalition_left_mean,
coalition_center=coalition_center_mean,
coalition_right=coalition_right_mean,
singlecolor_left=singlecolor_left_mean,
singlecolor_center=singlecolor_center_mean,
singlecolor_right=singlecolor_right_mean,
repetition_elections=rep_elections_mean) %>%
mutate_if(is.numeric, round, 2) %>%
mutate(datetime2 = as.Date(datetime, 'd%.m%.Y%')) %>%
filter(datetime<"2019-05-05")
generales_little <- generales_reduce %>%
ungroup(datetime) %>%
select(datetime, `Gobierno de coalición de izquierdas`= "coalition_left", `Gobierno de coalición de centro`="coalition_center", `Gobierno de coalición de derechas`="coalition_right", `Gobierno monocolor de izquierdas`="singlecolor_left", `Gobierno monocolor de centro`="singlecolor_center", `Gobierno monocolor de derechas`="singlecolor_right", `Repetición de elecciones`="repetition_elections") %>%
gather("type", "prob", c(`Gobierno de coalición de izquierdas`:`Repetición de elecciones`)) %>%
mutate(diff =  prob - lag(prob, default = first(prob))) %>%
filter(datetime == max(datetime)) %>%
mutate_if(is.numeric, round, 2) %>%
select(type, prob, diff) %>%
arrange(desc(prob))
generales_gather <- generales_reduce %>% select(datetime, `Coalición de izquierda`= "coalition_left", `Coalición de centro`="coalition_center", `Coalición de derecha`="coalition_right", `Monocolor de izquierda`="singlecolor_left", `Monocolor de centro`="singlecolor_center", `Monocolor de derecha`="singlecolor_right", `Repetición electoral`="repetition_elections") %>%
gather("type", "prob", c(`Coalición de izquierda`:`Repetición electoral`))
###visual representations
####WEB
index <- sub_gather %>%
bind_rows(bar_gather) %>%
spread(set_id, prob) %>%
select(datetime, type, coloract, España= "espana", `C. Valenciana`= "cvalenciana", `C. Madrid`="cmadrid", Madrid="madrid", Barcelona="barcelona", Valencia="valencia")
